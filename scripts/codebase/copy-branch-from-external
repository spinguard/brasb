#!/bin/bash

# Script to copy a branch from an external/local repository to this repository
# Usage: ./copy-branch-from-external.sh <external_repo_path> <branch_name> [local_branch_name]

set -e  # Exit on error

# Check if correct number of arguments provided
if [ $# -lt 2 ] || [ $# -gt 3 ]; then
    echo "Error: Invalid number of arguments"
    echo "Usage: $0 <external_repo_path> <branch_name> [local_branch_name]"
    echo "  external_repo_path: Path or URL to the external repository"
    echo "  branch_name: Name of the branch to copy from external repo"
    echo "  local_branch_name: (optional) Name for the local branch (defaults to branch_name)"
    exit 1
fi

EXTERNAL_REPO="$1"
BRANCH_NAME="$2"
LOCAL_BRANCH_NAME="${3:-$BRANCH_NAME}"

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "Error: Not in a git repository"
    exit 1
fi

# Check if external repo path exists (if it's a local path)
if [ ! -d "$EXTERNAL_REPO" ] && [[ ! "$EXTERNAL_REPO" =~ ^https?:// ]] && [[ ! "$EXTERNAL_REPO" =~ ^git@ ]]; then
    echo "Error: External repository path does not exist: $EXTERNAL_REPO"
    exit 1
fi

# Check if local branch already exists
if git show-ref --verify --quiet refs/heads/"$LOCAL_BRANCH_NAME"; then
    echo "Error: Local branch '$LOCAL_BRANCH_NAME' already exists"
    exit 1
fi

# Generate a unique temporary remote name
TEMP_REMOTE="temp-external-$(date +%s)"

# Add the external repo as a temporary remote
echo "Adding external repository as temporary remote '$TEMP_REMOTE'..."
if ! git remote add "$TEMP_REMOTE" "$EXTERNAL_REPO"; then
    echo "Error: Failed to add remote repository"
    exit 1
fi

# Cleanup function to remove temporary remote
cleanup() {
    echo "Cleaning up temporary remote '$TEMP_REMOTE'..."
    git remote remove "$TEMP_REMOTE" 2>/dev/null || true
}

# Set trap to cleanup on exit
trap cleanup EXIT

# Fetch the branch from the external repository
echo "Fetching branch '$BRANCH_NAME' from external repository..."
if ! git fetch "$TEMP_REMOTE" "$BRANCH_NAME"; then
    echo "Error: Failed to fetch branch '$BRANCH_NAME' from external repository"
    echo "Make sure the branch exists in the external repository"
    exit 1
fi

# Check if the remote branch was fetched successfully
if ! git show-ref --verify --quiet "refs/remotes/$TEMP_REMOTE/$BRANCH_NAME"; then
    echo "Error: Branch '$BRANCH_NAME' not found in external repository"
    exit 1
fi

# Create and checkout the local branch from the remote branch
echo "Creating local branch '$LOCAL_BRANCH_NAME' from external branch..."
git checkout -b "$LOCAL_BRANCH_NAME" "$TEMP_REMOTE/$BRANCH_NAME"

echo "Successfully copied branch '$BRANCH_NAME' from external repository to local branch '$LOCAL_BRANCH_NAME'!"
echo "Current branch: $(git branch --show-current)"
